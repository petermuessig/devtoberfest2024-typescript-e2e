const cds = require('../../index'), { decodeURI } = cds.utils

if (cds.env.features.odata_new_adapter) {
  cds.log().info('using new OData adapter')

  module.exports = require('../../../libx/odata/ODataAdapter')
} else {
  cds.log().info('using legacy OData adapter')

  const legacy_adapter_factory = require('../../../libx/_runtime/cds-services/adapter/odata-v4/to')
  const LOG = cds.log('odata')

  module.exports = function ODataAdapter(srv) {
    const router = require('express').Router()

    router.use(function odata_log(req, _, next) {
      let url = decodeURI(req.originalUrl)
      LOG && LOG(req.method, url, req.body || '')
      if (/\$batch/.test(req.url))
        req.on('dispatch', req => {
          let path = decodeURI(req._.odataReq?._rawODataPath || '')
          LOG && LOG('>', req.event, path, req._queryOptions || '')
          if (LOG._debug && req.query) LOG.debug(req.query) //> why only for batch subrequests?
        })

      next()
    })
    router.use(legacy_adapter_factory(srv))
    return router
  }
}
