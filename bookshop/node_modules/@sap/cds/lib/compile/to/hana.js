const cds = require('../..')
const cdsc = require('../cdsc')

module.exports = (csn, o, beforeCsn) => {
  if (typeof beforeCsn === 'string') beforeCsn = JSON.parse(beforeCsn)

  const { definitions, deletions, migrations, afterImage } = cdsc.to.hdi.migration(cds.minify(csn), o, beforeCsn)
  let migrationResult = false
  if (beforeCsn || Object.values(afterImage.definitions).some(def => def['@cds.persistence.journal'])) {
    migrationResult = true
  }

  return (function* () {
    for (const { name, suffix, sql } of definitions) {
      yield [sql, { file: name + suffix }]
    }
    if (deletions.length > 0) {
      yield [deletions, { file: 'deletions.json' }]
    }
    if (migrations.length > 0) {
      yield [migrations, { file: 'migrations.json' }]
    }
    if (migrationResult) {
      yield [afterImage, { file: 'afterImage.json' }]
    }
  })()
}
