const cds = require('../cds')
const search2cqn4sql = require('./search2cqn4sql')

const _setSearchOptions = (query, _searchOptions) => {
  if (!(query && query.SELECT)) return
  if (query.SELECT.search) Object.defineProperty(query, '_searchOptions', { value: _searchOptions })
  if (query.SELECT.from.SELECT) _setSearchOptions(query.SELECT.from, _searchOptions)
}

function searchHandler(req) {
  // REVISIT: remove feature toggle optimized_search after grace period
  // inject the search2cqn4sql module into the rewrite handler only when
  // the optimized search feature toggle is turned on
  if (cds.env.features.optimized_search === false) return
  _setSearchOptions(req.query, { search2cqn4sql, locale: req.locale })
}

// handlers marked with `._initial = true` run in sequence
searchHandler._initial = true
module.exports = searchHandler
