const { hasDeepInsert, getDeepInsertCQNs } = require('../../common/composition')
const { getFlatArray, processCQNs } = require('../utils/deep')
const normalizeTimestamp = require('../../common/utils/normalizeTimestamp')

const insert = executeInsertCQN => async (model, dbc, query, req) => {
  const { user, locale, timestamp } = req
  const isoTs = normalizeTimestamp(timestamp)

  if (model && hasDeepInsert(model, query)) {
    const cqns = getFlatArray(getDeepInsertCQNs(model, query))

    // return array of individual results
    if (cqns.length === 0) return []
    const results = await processCQNs(executeInsertCQN, cqns, model, dbc, user, locale, isoTs)
    return getFlatArray(results)
  }

  return executeInsertCQN(model, dbc, query, user, locale, isoTs)
}

module.exports = insert
