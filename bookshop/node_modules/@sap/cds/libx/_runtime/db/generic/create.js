const InsertResult = require('../result/InsertResult')

/**
 * Generic Handler for CREATE requests.
 * REVISIT: add description
 *
 * @param req - cds.Request
 */
module.exports = async function (req) {
  if (typeof req.query === 'string') {
    const results = await this._execute.sql(this.dbc, req.query, req.data)
    return Array.isArray(results) && results[0] != null && results[0].affectedRows != null
      ? results[0].affectedRows
      : results
  }

  try {
    const results = await this._insert(this.model, this.dbc, req.query, req)
    return new InsertResult(req, results)
  } catch (err) {
    // If entry is available, reject event
    // REVISIT: db specifics
    if (err.message.match(/unique constraint/i)) {
      err.originalMessage = err.message
      err.message = 'ENTITY_ALREADY_EXISTS'
      err.code = 400
    }
    req.reject(err)
  }
}
