const cds = require('../../cds')
const resolveStructured = require('../../common/utils/resolveStructured')

const _isStreamProperty = element => {
  return element.type === 'cds.LargeBinary' || (element['@Core.MediaType'] && element['@Core.IsURL'])
}

/**
 * This method gets all columns for an entity.
 * It includes the generated foreign keys from managed associations, structured elements and complex and custom types.
 * As well, it provides the annotations starting with '@' for each column.
 *
 * @param entity - the csn entity
 * @returns {Array} - array of columns
 */
const getColumns = (entity, { onlyKeys, omitStream } = { onlyKeys: false, omitStream: false }) => {
  // REVISIT is this correct or just a problem that occurs because of new structure we do not deal with yet?
  if (!(entity && entity.elements)) return []
  const columnNames = []
  // REVISIT!!!
  const { structs = cds.env.features.ucsn_struct_conversion } = cds.env.effective.odata
  const elements = entity.elements
  for (const elementName in elements) {
    const element = elements[elementName]
    if (element['@cds.api.ignore']) continue
    if (onlyKeys && !element.key) continue
    if (omitStream && _isStreamProperty(element)) continue
    if (element.isAssociation) continue
    if (structs && element.elements) {
      columnNames.push(...resolveStructured({ element, structProperties: [] }, false))
      continue
    }
    columnNames.push(elementName)
  }
  return columnNames.map(name => elements[name] || { name })
}

/*
 * this module is required by cds-pg. -> in case of incompatible changes, we should let them know.
 */
module.exports = getColumns
