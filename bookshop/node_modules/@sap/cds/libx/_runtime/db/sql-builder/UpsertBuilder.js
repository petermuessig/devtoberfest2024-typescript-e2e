const InsertBuilder = require('./InsertBuilder')
const getAnnotatedColumns = require('./annotations')

class UpsertBuilder extends InsertBuilder {
  constructor(obj, options, csn) {
    super(obj, options, csn)
    this._UPSERT = true
  }

  annotatedColumns(entityName, csn) {
    const { updateAnnotatedColumns } = getAnnotatedColumns(entityName, csn)
    return { insertAnnotatedColumns: updateAnnotatedColumns }
  }

  // REVISIT: We need to copy over the implementation for annotation handling
  build() {
    this._obj = { INSERT: this._obj.UPSERT }
    super.build()
    this._outputObj.sql = this._outputObj.sql.replace('INSERT INTO', 'UPSERT')
    this._outputObj.sql += ' WITH PRIMARY KEY'
    return this._outputObj
  }
}

module.exports = UpsertBuilder
