const replaceManagedData = require('../../common/utils/dollar')

const _object = (row, user, now, elements) => {
  Object.keys(row).forEach(k => {
    if (elements?.[k]?.['@cds.on.insert'] || elements?.[k]?.['@cds.on.update']) replaceManagedData(row, k, user, now)
  })
}

const _array = (row, user, now) => {
  for (let i = 0; i < row.length; i++) {
    replaceManagedData(row, i, user, now)
  }
}

const entries = (_entries, user, now, elements) => {
  if (!Array.isArray(_entries)) _object(_entries, user, now, elements)
  else for (const row of _entries) _object(row, user, now, elements)
}

const values = (_values, user, now) => {
  _array(_values, user, now)
}

const rows = (_rows, user, now) => {
  for (const row of _rows) _array(row, user, now)
}

const data = (_data, user, now, elements) => {
  _object(_data, user, now, elements)
}

module.exports = {
  entries,
  values,
  rows,
  data
}
