const cds = require('../../cds')
// REVISIT: Remove after removing okra
const { isStreaming } = require('../../cds-services/adapter/odata-v4/utils/stream')

const _isStream = query => {
  const { _propertyAccess, target } = query
  if (!_propertyAccess) return

  const element = target.elements[_propertyAccess]
  return element._type === 'cds.LargeBinary' && element['@Core.MediaType']
}

const _getStreamingProperties = elements => {
  const result = []
  for (const key in elements) {
    const element = elements[key]
    if (typeof element['@Core.MediaType'] === 'object') {
      result.push({ stream: key, type: element['@Core.MediaType']['='] })
    }
  }

  return result
}

const _getMediaTypeValue = () => {
  const ctx = cds.context
  return !ctx?.http?.req?.headers?.['content-type']?.match(/multipart/i) && ctx?.http?.req?.headers?.['content-type']
}

function _addContentType(req, mtValue) {
  if (!req.data) return
  const streamProp = _getStreamingProperties(req.target.elements).find(prop => req.data[prop.stream])
  if (streamProp) req.data[streamProp.type] = mtValue
}

async function addContentType(req) {
  if (!req.query || !req.target) return
  if (req._.odataReq) {
    if (!isStreaming(req._.odataReq.getUriInfo().getPathSegments())) return
  } else if (req.req?._query) {
    if (!_isStream(req.req._query)) return
  }

  const mtValue = _getMediaTypeValue()
  if (!mtValue) return

  _addContentType(req, mtValue)
}

// register after input.js in order to write content-type also for @Core.Computed fields
module.exports = cds.service.impl(function () {
  this.before(['PATCH', 'UPDATE'], '*', addContentType)
})
