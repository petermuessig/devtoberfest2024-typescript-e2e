const cds = require('../../cds')
const { DRAFT_COLUMNS_MAP } = require('../../common/constants/draft')

const _getStaticOrders = req => {
  const { target: entity, query } = req
  const defaultOrders = entity['@cds.default.order'] || entity['@odata.default.order'] || []

  if (entity['@cds.default.order']) {
    // Remove with cds^8
    cds.utils.deprecated({ kind: 'Annotation', old: '@cds.default.order of entity ' + entity.name })
  }
  if (entity['@odata.default.order']) {
    // Remove with cds^8
    cds.utils.deprecated({ kind: 'Annotation', old: '@odata.default.order of entity ' + entity.name })
  }

  const ordersFromKeys = []

  if (req.target._isSingleton || query.SELECT.limit) {
    const keys = [...(entity.keys || [])].filter(k => !k.isAssociation).map(k => k.name)
    for (const key of keys) {
      if (!(key in DRAFT_COLUMNS_MAP) && !defaultOrders.some(o => o.by['='] === key)) {
        ordersFromKeys.push({ by: { '=': key } })
      }
    }
  }

  if (entity.query && entity.query.SELECT && entity.query.SELECT.orderBy) {
    const orderBy = entity.query.SELECT.orderBy
    const ordersFromView = orderBy.map(keyName => ({
      by: { '=': keyName.ref[keyName.ref.length - 1] },
      desc: keyName.sort === 'desc'
    }))
    return [...ordersFromView, ...defaultOrders, ...ordersFromKeys]
  }

  return [...defaultOrders, ...ordersFromKeys]
}

const _addDefaultSortOrder = (req, select) => {
  // "static orders" = the orders not from the query options
  let staticOrders = _getStaticOrders(req)

  // remove defaultOrder if not part of group by
  const groupBy = select?.groupBy || select?.from?.SELECT?.groupBy

  if (groupBy?.length > 0) staticOrders = staticOrders.filter(d => groupBy.some(e => e.ref[0] === d.by['=']))

  if (!staticOrders.length) return

  if (select?.from?.SELECT?.groupBy?.length > 0) select = select.from.SELECT
  select.orderBy = select.orderBy ?? []
  select.orderBy.push(
    ...staticOrders
      .filter(d => !select.orderBy.find(o => o.ref && o.ref.join('_') === d.by['=']))
      .map(d => ({ ref: [d.by['=']], sort: d.desc ? 'desc' : 'asc' }))
  )
}

/**
 * 1. query options --> already set in req.query
 * 2. orders from view || @cds.default.order/@odata.default.order
 * 3. orders from keys if singleton or limit is set
 *
 * @param req
 */
const commonGenericSorting = function (req) {
  if (!req.query || !req.query.SELECT || req.query.SELECT.one) return

  let select = req.query.SELECT

  // do not sort for /$count queries or queries only using aggregations
  if (select.columns && select.columns.length && select.columns.every(col => col.func)) {
    return
  }

  if (select.from && select.from.SELECT) {
    // add default sort to root query
    if (select.orderBy) _addDefaultSortOrder(req, select)

    // apply default sort to bottom-most sub-query
    while (select.from.SELECT) select = select.from.SELECT
  }
  _addDefaultSortOrder(req, select)
}

/**
 * handler registration
 */
module.exports = cds.service.impl(function () {
  commonGenericSorting._initial = true
  this.before('READ', '*', commonGenericSorting)
})

// needed in lean draft
module.exports.handler = commonGenericSorting
