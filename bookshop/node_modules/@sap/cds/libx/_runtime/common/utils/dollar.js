const cds = require('../../cds')

module.exports = (entryOrRow, keyOrIndex, user, timestamp) => {
  const v = entryOrRow[keyOrIndex]
  if (!v) return

  // REVISIT: shouldn't be necessary, but sql builder default for user currently cannot be an object (test issue?)
  // normalize user (object vs. string)
  user = user && user.id ? user : { id: user || 'anonymous' }

  if (v === '$user') entryOrRow[keyOrIndex] = user.id
  else if (v === '$now') entryOrRow[keyOrIndex] = timestamp
  else if (v === '$uuid') entryOrRow[keyOrIndex] = cds.utils.uuid()
  else if (typeof v === 'string') {
    // NOTE: with xsuaa, user attributes are always arrays
    const attr = v.match(/^\$user\.(.*)/)
    if (attr) {
      const val = (user.attr && user.attr[attr[1]]) || null
      if (Array.isArray(val)) {
        if (val.length > 1) entryOrRow[keyOrIndex] = JSON.stringify(val)
        else entryOrRow[keyOrIndex] = val.length > 0 ? val[0] : null
      } else {
        entryOrRow[keyOrIndex] = val
      }
    }
  }
}
