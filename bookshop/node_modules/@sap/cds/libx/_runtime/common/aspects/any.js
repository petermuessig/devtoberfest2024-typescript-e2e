const { foreignKey4 } = require('../../common/utils/foreignKeyPropagations')

const _getCommonFieldControl = e => {
  const cfr = e['@Common.FieldControl']
  return cfr && cfr['#']
}

const _isMandatory = e => {
  return (
    e['@assert.mandatory'] !== false &&
    (e['@mandatory'] ||
      e['@Common.FieldControl.Mandatory'] ||
      e['@FieldControl.Mandatory'] ||
      _getCommonFieldControl(e) === 'Mandatory')
  )
}

const _isReadOnly = e => {
  return (
    e['@readonly'] ||
    e['@cds.on.update'] ||
    e['@cds.on.insert'] ||
    e['@Core.Computed'] ||
    e['@Common.FieldControl.ReadOnly'] ||
    e['@FieldControl.ReadOnly'] ||
    _getCommonFieldControl(e) === 'ReadOnly'
  )
}

const Relation = require('./relation')

const _exposeRelation = relation => Object.defineProperty({}, '_', { get: () => relation })

const _relationHandler = relation => ({
  get: (target, name) => {
    const path = name.split(',')
    const prop = path.join('_')
    if (!target[prop]) {
      if (path.length === 1) {
        // REVISIT: property 'join' must not be used in CSN to make this working
        if (relation._has(prop)) return relation[prop]
        const newRelation = Relation.to(relation, prop)
        if (newRelation) {
          target[prop] = new Proxy(_exposeRelation(newRelation), _relationHandler(newRelation))
        }

        return target[prop]
      }

      target[prop] = path.reduce((relation, value) => relation[value] || relation.csn._relations[value], relation)
      target[prop].path = path
    }

    return target[prop]
  }
})

const _getRelations = e => {
  const newRelation = Relation.to(e)
  return new Proxy(_exposeRelation(newRelation), _relationHandler(newRelation))
}

// NOTE: Please only add things which are relevant to _any_ type,
// use specialized types otherwise (entity, Association, ...).
module.exports = class {
  get _isStructured() {
    return this.own('__isStructured', () => !!this.elements && this.kind !== 'entity')
  }

  get _isMandatory() {
    return this.own('__isMandatory', () => !this.isAssociation && _isMandatory(this))
  }

  get _isReadOnly() {
    return this.own('__isReadOnly', () => !this.key && _isReadOnly(this))
  }

  get _mandatories() {
    return this.own(
      '__mandatories',
      // eslint-disable-next-line no-unused-vars
      () => this.elements && Object.entries(this.elements).filter(([_, v]) => v._isMandatory)
    )
  }

  // REVISIT: Where to put?
  get _relations() {
    return this.own('__relations', () => _getRelations(this))
  }

  get _foreignKey4() {
    return this.own('__foreignKey4', () => foreignKey4(this))
  }
}
