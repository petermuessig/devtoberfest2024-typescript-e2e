const cds = require('../../lib')
module.exports = cds

/*
 * csn aspects
 */
const { any, entity, Association } = cds.builtin.classes
cds.extend(any).with(require('./common/aspects/any'))
cds.extend(Association).with(require('./common/aspects/Association'))
cds.extend(entity).with(require('./common/aspects/entity'))

/*
 * Determines whether a request requires resolving of the target entity.
 * Added to cds.Service so it can be reused in cds.ApplicationService and cds.RemoteService.
 */
cds.Service.prototype._requires_resolving = function (req) {
  const already_resolved = req._resolved
  const belongs_to_me = req.target?.name?.startsWith(this.definition?.name + '.')
  const is_resolvable = this.model && _is_simple_cqn_query(req.query)
  const requires_resolving = !(already_resolved || belongs_to_me) && is_resolvable
  return requires_resolving
}
const _is_simple_cqn_query = q => typeof q === 'object' && q !== null && !Array.isArray(q) && Object.keys(q).length > 0
