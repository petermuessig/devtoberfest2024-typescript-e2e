const cds = require('../cds')

function sqliteConvertDraftAdminPathExpression(req) {
  if (req.query?.SELECT?.from?.SET) return // not supported, won't happen in draft
  if (req.query?.SELECT?.from?.args) return // not supported, won't happen in draft
  if (
    !req.query?.SELECT ||
    !req.query?._target?.name?.endsWith('.drafts') ||
    req.query?.SELECT?.from?.args?.some(a => a.ref?.[0] === 'DRAFT_DraftAdministrativeData')
  )
    return
  let hasDraftAdminPathExpression = false

  const tableId = req.query.SELECT.from.as || req.query.SELECT.from.ref[0]

  const _modifyCols = cols => {
    return cols.map(col => {
      if (col.ref?.length > 1 && col.ref[0] === 'DraftAdministrativeData') {
        hasDraftAdminPathExpression = true
        const newCol = { ...col }
        newCol.ref = [...col.ref]
        newCol.ref[0] = 'filterAdmin'
        return newCol
      } else if (col.ref?.length > 1 && tableId && col.ref[0] === tableId && col.ref[1] === 'DraftAdministrativeData') {
        hasDraftAdminPathExpression = true
        const newCol = { ...col }
        newCol.ref = [...col.ref]
        newCol.ref.shift()
        newCol.ref[0] = 'filterAdmin'
        return newCol
      }
      if (col.expand) {
        const newCol = { ...col }
        newCol.expand = _modifyCols(col.expand)
        return newCol
      }
      return col
    })
  }

  const clone = cds.ql.clone(req.query)

  if (clone.SELECT.columns) clone.SELECT.columns = _modifyCols(req.query.SELECT.columns)
  if (clone.SELECT.where) clone.SELECT.where = _modifyCols(req.query.SELECT.where)
  if (clone.SELECT.orderBy) clone.SELECT.orderBy = _modifyCols(req.query.SELECT.orderBy)
  if (clone.SELECT.groupBy) clone.SELECT.groupBy = _modifyCols(req.query.SELECT.groupBy)

  const _addTableId = c => {
    if (!c.ref || c.ref[0] === tableId || c.ref[0] === 'filterAdmin') return c
    const newC = { ...c }
    newC.ref = [...c.ref]
    newC.ref.unshift(tableId)
    return newC
  }

  if (hasDraftAdminPathExpression) {
    clone
      .join('DRAFT_DraftAdministrativeData', 'filterAdmin')
      .on([
        { ref: tableId ? [tableId, 'DraftAdministrativeData_DraftUUID'] : ['DraftAdministrativeData_DraftUUID'] },
        '=',
        { ref: ['filterAdmin', 'DraftUUID'] }
      ])
    if (tableId) {
      if (clone.SELECT.columns) clone.SELECT.columns = clone.SELECT.columns.map(_addTableId)
      if (clone.SELECT.where) clone.SELECT.where = clone.SELECT.where.map(_addTableId)
      if (clone.SELECT.orderBy) clone.SELECT.orderBy = clone.SELECT.orderBy.map(_addTableId)
      if (clone.SELECT.groupBy) clone.SELECT.groupBy = clone.SELECT.groupBy.map(_addTableId)
    }
    req.query = clone
  }
}
sqliteConvertDraftAdminPathExpression._initial = true
module.exports = sqliteConvertDraftAdminPathExpression
